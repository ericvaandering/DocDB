#! /usr/bin/env perl
#
#        Name: DisplayMeeting
# Description: Displays talks for a meeting or just a session of a meeting
# 
#      Author: Eric Vaandering (ewv@fnal.gov)
#    Modified: 
#

use CGI;
use DBI;

require "DocDBGlobals.pm";
require "HTMLUtilities.pm";
require "ResponseElements.pm";
require "Sorts.pm";
require "Scripts.pm";

require "MeetingHTML.pm";
require "MeetingSQL.pm";

require "TalkHintUtilities.pm";

$query = new CGI;  # Global for subroutines

print $query -> header;
&DocDBHeader("Meeting Talks");
&TalkNotePopupScript;

%params = $query -> Vars;

my $SessionID          = $params{sessionid};
my $SessionSeparatorID = $params{sessionseparatorid};
my $ConferenceID       = $params{conferenceid};

@ErrorStack = ();
@WarnStack  = ();

$dbh   = DBI -> connect('DBI:mysql:'.$db_name.':'.$db_host,$db_rwuser,$db_rwpass);

unless ($dbh) {
  push @ErrorStack,$Msg_NoConnect;
}         
&EndPage(@ErrorStack);

if ($SessionID) { # Display a single session
  &ReHintTalksBySessionID($SessionID); 
  &ClearSessionTalks();

  &FetchSessionByID($SessionID);
  &FetchConferenceByConferenceID($Sessions{$SessionID}{ConferenceID});
  &PrintMeetingInfo($Sessions{$SessionID}{ConferenceID});
  &PrintSession($SessionID); 
  &PrintMeetingEpilogue($Sessions{$SessionID}{ConferenceID});
} elsif ($SessionSeparatorID) { # Display a single break (never called)
  &FetchSessionSeparatorByID($SessionSeparatorID);
  &FetchConferenceByConferenceID($SessionSeparators{$SessionSeparatorID}{ConferenceID});
  &PrintMeetingInfo($Sessions{$SessionID}{ConferenceID});
  &PrintSessionSeparator($SessionSeparatorID);
  &PrintMeetingEpilogue($Sessions{$SessionID}{ConferenceID});
} elsif ($ConferenceID) { # Display meeting info or meeting with all talks
  &FetchConferenceByConferenceID($ConferenceID);
  &PrintMeetingInfo($ConferenceID);
    
  my @MeetingOrderIDs = &FetchMeetingOrdersByConferenceID($ConferenceID);
  @MeetingOrderIDs = sort MeetingOrderIDByOrder @MeetingOrderIDs; 
  if ($Conferences{$ConferenceID}{ShowAllTalks}) { # Display all talks, sessions
    # FIXME: Add a Navbar of sorts?
    foreach $MeetingOrderID (@MeetingOrderIDs) { # Loop over sessions/breaks
      my $SessionID          = $MeetingOrders{$MeetingOrderID}{SessionID};
      my $SessionSeparatorID = $MeetingOrders{$MeetingOrderID}{SessionSeparatorID};
      if ($SessionID) {
        &ReHintTalksBySessionID($SessionID); 
        &ClearSessionTalks();
        &FetchSessionByID($SessionID);
        &PrintSession($SessionID); # Display a single session
      } elsif ($SessionSeparatorID) {
        &FetchSessionSeparatorByID($SessionSeparatorID);
        &PrintSessionSeparator($SessionSeparatorID); # Display session separator
      }
    }   
  } else { # Display links to sessions and info on separators
    print "<center><table cellpadding=5>\n";
    print "<tr><th>Session Title</th>\n";
    print "<th>Date & Time</th>\n";
    print "<th>Session Information</th>\n";
    print "<th>Location</th>\n";
    print "</tr>\n";
    foreach $MeetingOrderID (@MeetingOrderIDs) {
      my $SessionID          = $MeetingOrders{$MeetingOrderID}{SessionID};
      my $SessionSeparatorID = $MeetingOrders{$MeetingOrderID}{SessionSeparatorID};
      if ($SessionID) {
        &PrintSessionInfo($SessionID); # Session info and link to session
      } elsif ($SessionSeparatorID) {
        &PrintSessionSeparatorInfo($SessionSeparatorID); # SessionSeparator info 
      }
    }  
    print "</table></center><hr width=95%>\n";
  }
  
# If a topic-based meeting, display talks not associated with sessions  

  if ($params{conferenceid} && $Conferences{$ConferenceID}{Minor}) {
    require "RevisionSQL.pm";
    require "DocumentSQL.pm";
    
    my $MinorTopicID = $Conferences{$ConferenceID}{Minor};
    my @DocRevIDs = &FetchRevisionsByMinorTopic($MinorTopicID);
    my %DocumentIDs = ();
    foreach my $DocRevID (@DocRevIDs) {
      $DocumentIDs{$DocRevisions{$DocRevID}{DOCID}} = 1;
    }
    
    # Refetch all talks
    my @MeetingOrderIDs = &FetchMeetingOrdersByConferenceID($ConferenceID);
    foreach $MeetingOrderID (@MeetingOrderIDs) {
      my $SessionID = $MeetingOrders{$MeetingOrderID}{SessionID};
      if ($SessionID) {
        &FetchSessionByID($SessionID);
        &FetchSessionTalksBySessionID($SessionID);
      }
    }   

    # Flag talks which are associated with a session
    foreach my $SessionTalkID (keys %SessionTalks) {
      my $SessionID = $SessionTalks{$SessionTalkID}{SessionID};
      if ($Sessions{$SessionID}{ConferenceID} == $ConferenceID) {
        if ($SessionTalks{$SessionTalkID}{DocumentID}) {
          $DocumentIDs{$SessionTalks{$SessionTalkID}{DocumentID}} = 0;
        }
      }
    } 

    # Find which ones aren't
    my @UnusedDocIDs = ();
    foreach my $DocumentID (keys %DocumentIDs) {
      if ($DocumentIDs{$DocumentID}) {
        push @UnusedDocIDs,$DocumentID;
      }  
    }
    
    # Print out info for unused documents
    if (@UnusedDocIDs) {
      print "<center>\n";
      print "<b>Other talks for this meeting:</b>\n";
      print "<table cellpadding=3>\n";
      &DocumentSummary(0,"meeting");
      foreach my $DocumentID (@UnusedDocIDs) {
        unless ($DocumentID) {next;}
        my $Version = &LastAccess($DocumentID);
        if ($Version == -1) {next;}
        &DocumentSummary($DocumentID,"meeting",$Version);
      }
      print "</table></center><hr width=95%>\n";
    }
  }
  &PrintMeetingEpilogue($ConferenceID);
} else {
  #Complain that user didn't specify a session, break, or conference
}  
  
&DocDBNavBar;
&DocDBFooter($DBWebMasterEmail,$DBWebMasterName);
 
exit;
