FROM almalinux:9

# Add some optional repo packages to get older stuff
RUN dnf -y install 'dnf-command(config-manager)'\
    && dnf clean all \
    && rm -rf /var/cache/dnf
RUN dnf config-manager --set-enabled crb
RUN dnf install -y epel-release \
    && dnf clean all \
    && rm -rf /var/cache/dnf

RUN dnf upgrade -y && \
    dnf clean all && \
    rm -rf /var/cache/yum

RUN dnf install -y httpd mod_ssl \
                   sudo git \
                   sendmail sendmail-cf python pip python-pip \
                   && yum clean all \
                   && rm -rf /var/cache/yum

RUN dnf install -y perl perl-CPAN perl-CGI perl-DBI perl-DBD-MySQL perl-DateTime perl-File-MimeInfo \
                   perl-MailTools perl-XML-Twig perl-libxml-perl perl-DateTime-Format-ICal perl-libwww-perl \
                   perl-Digest-SHA1 perl-XML-Simple \
                   && yum clean all \
                   && rm -rf /var/cache/yum

RUN dnf -y install https://www.rpmfind.net/linux/almalinux/9.7/devel/x86_64/os/Packages/perl-Class-ReturnValue-0.55-38.el9.noarch.rpm https://www.rpmfind.net/linux/almalinux/9.7/devel/x86_64/os/Packages/perl-Data-ICal-0.24-7.el9.noarch.rpm \
    && dnf clean all \
    && rm -rf /var/cache/dnf

# Jobber is a lightweight cron replacement written in Go
RUN rpm -i https://github.com/dshearer/jobber/releases/download/v1.4.4/jobber-1.4.4-1.el8.x86_64.rpm
ADD dot-jobber.yaml /root/.jobber

# j2cli is used for templating config files which will be useful for passing environment variables
RUN python3 -m pip install --no-cache-dir --upgrade pip
RUN python3 -m pip install --no-cache-dir --upgrade setuptools
RUN python3 -m pip install --no-cache-dir j2cli

# This file was generated by running CPAN once in "manual" not "local::lib" mode
ADD MyConfig.pm /root/.cpan/CPAN/MyConfig.pm
RUN sudo cpan -i CGI::Untaint

# Get DocDB software and install it
RUN git clone https://github.com/ericvaandering/DocDB.git
RUN mkdir -p /var/www/cgi-bin/DocDB && cp DocDB/DocDB/cgi/* /var/www/cgi-bin/DocDB
RUN mkdir -p /var/www/html/DocDB/Static/ && cp -R /DocDB/DocDB/html/css/ /DocDB/DocDB/html/js/ /DocDB/DocDB/html/img/ /var/www/html/DocDB/Static/

ADD docker-entrypoint.sh /
ENTRYPOINT ["/docker-entrypoint.sh"]
